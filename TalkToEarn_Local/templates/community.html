<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å†…å®¹åˆ†äº« - AIçŸ¥è¯†åº“å¹³å°</title>
    <style>
        /* æ ·å¼ä¸dashboard.htmlç±»ä¼¼ï¼Œä¸ºç®€æ´èµ·è§çœç•¥é‡å¤æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0066cc, #0099ff);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .nav-bar {
            background: #f8f9fa;
            padding: 15px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: #0066cc;
            color: white;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #495057;
        }
        
        .coin-balance {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8a6d3b;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0066cc, #0099ff);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .file-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .file-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }
        
        .file-id {
            font-family: monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #495057;
        }
        
        .file-author {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .file-content {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .file-content:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, white);
        }
        
        .file-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #f1f1f1;
            padding-top: 12px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            grid-column: 1 / -1;
        }
        
        .rag-badge {
            background: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .view-detail-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .view-detail-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å†…å®¹åˆ†äº«ç¤¾åŒº</h1>
            <div class="subtitle">æ¢ç´¢å¹³å°ä¸Šçš„ä¼˜è´¨å†…å®¹</div>
        </div>
        
        <div class="nav-bar">
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/dashboard">æ§åˆ¶å°</a>
                <a href="/community" class="active">å†…å®¹åˆ†äº«</a>
                <a href="/profile">æˆ‘çš„è´¦æˆ·</a>
            </div>
            
            <div class="user-info">
                <span>æ¬¢è¿, {{ session.user_id }}</span>
                <a href="/dashboard" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">åˆ†äº«å†…å®¹</a>
            </div>
        </div>
        
        <div class="main-content">

            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢æ–‡ä»¶IDã€æ–‡ä»¶åæˆ–å†…å®¹å…³é”®è¯...">
                <button onclick="searchFiles()" class="btn btn-primary">æœç´¢</button>
                <button onclick="clearSearch()" class="btn" style="background: #6c757d; color: white;">æ¸…ç©º</button>
            </div>
            
            <div class="file-grid" id="fileGrid">
                {% for file in files %}
                <div class="file-card" onclick="viewFileDetail('{{ file.file_id }}')">
                    <div class="file-header">
                        <div>
                            <div class="file-title">{{ file.filename }}</div>
                            <div class="file-author">ä½œè€…: {{ file.user_id }}</div>
                        </div>
                        <div class="file-id">{{ file.file_id }}</div>
                    </div>
                    
                    <div class="file-content">
                        {{ file.content }}
                    </div>
                    
                    <div class="file-stats">
                        <div class="stat-item">
                            ğŸ“… {{ file.upload_time[:10] }}
                        </div>
                        <div class="stat-item">
                            ğŸ”— {{ file.reference_count }} æ¬¡å¼•ç”¨
                        </div>
                        <div class="stat-item">
                            ğŸ’° {{ "%.6f"|format(file.total_reward) }} coin
                        </div>
                        {% if file.authorize_rag %}
                        <div class="rag-badge">AIå­¦ä¹ </div>
                        {% endif %}
                    </div>
                    
                    <button class="view-detail-btn" onclick="event.stopPropagation(); viewFileDetail('{{ file.file_id }}')">
                        æŸ¥çœ‹è¯¦æƒ…
                    </button>
                </div>
                {% else %}
                <div class="empty-state">
                    <h3>æš‚æ— åˆ†äº«å†…å®¹</h3>
                    <p>æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«å†…å®¹çš„äººå§ï¼</p>
                    <a href="/dashboard" class="btn btn-primary" style="margin-top: 15px;">ç«‹å³åˆ†äº«</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- åœ¨ community.html çš„ script éƒ¨åˆ†æ·»åŠ ä»¥ä¸‹ä»£ç  -->

    <script>
    // ä¼˜åŒ–æœç´¢åŠŸèƒ½
    async function searchFiles() {
        const keyword = document.getElementById('searchInput').value.trim();
        
        if (!keyword) {
            alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            return;
        }
        
        try {
            // æ˜¾ç¤ºæœç´¢ä¸­çŠ¶æ€
            const fileGrid = document.getElementById('fileGrid');
            fileGrid.innerHTML = '<div class="empty-state"><p>æœç´¢ä¸­...</p></div>';
            
            const response = await fetch(`/files?keyword=${encodeURIComponent(keyword)}`);
            const result = await response.json();
            
            if (result.success) {
                displayFiles(result.files);
            } else {
                alert('æœç´¢å¤±è´¥: ' + result.message);
                // é‡æ–°åŠ è½½æ‰€æœ‰æ–‡ä»¶
                location.reload();
            }
        } catch (error) {
            alert('æœç´¢é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            console.error('æœç´¢é”™è¯¯:', error);
            location.reload();
        }
    }

    // ä¼˜åŒ–æ–‡ä»¶æ˜¾ç¤ºå‡½æ•°
    function displayFiles(files) {
        const fileGrid = document.getElementById('fileGrid');
        
        if (files.length === 0) {
            fileGrid.innerHTML = `
                <div class="empty-state">
                    <h3>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</h3>
                    <p>å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢</p>
                    <button onclick="clearSearch()" class="btn btn-primary" style="margin-top: 15px;">æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶</button>
                </div>
            `;
            return;
        }
        
        fileGrid.innerHTML = files.map(file => `
            <div class="file-card" onclick="viewFileDetail('${file.file_id}')">
                <div class="file-header">
                    <div>
                        <div class="file-title">${file.filename}</div>
                        <div class="file-author">ä½œè€…: ${file.user_id}</div>
                    </div>
                    <div class="file-id">${file.file_id}</div>
                </div>
                
                <div class="file-content">
                    ${file.content}
                </div>
                
                <div class="file-stats">
                    <div class="stat-item">
                        ğŸ“… ${file.upload_time.substring(0, 10)}
                    </div>
                    <div class="stat-item">
                        ğŸ”— ${file.reference_count} æ¬¡å¼•ç”¨
                    </div>
                    <div class="stat-item">
                        ğŸ’° ${parseFloat(file.total_reward).toFixed(6)} coin
                    </div>
                    ${file.authorize_rag ? '<div class="rag-badge">AIå­¦ä¹ </div>' : ''}
                </div>
                
                <button class="view-detail-btn" onclick="event.stopPropagation(); viewFileDetail('${file.file_id}')">
                    æŸ¥çœ‹è¯¦æƒ…
                </button>
            </div>
        `).join('');
    }

    // æ¸…ç©ºæœç´¢
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        location.reload();
    }

    // æŸ¥çœ‹æ–‡ä»¶è¯¦æƒ… - è¿™æ˜¯ç¼ºå¤±çš„å…³é”®å‡½æ•°ï¼
    function viewFileDetail(fileId) {
        if (!fileId) {
            alert('æ–‡ä»¶IDæ— æ•ˆ');
            return;
        }
        console.log('æ­£åœ¨æ‰“å¼€æ–‡ä»¶è¯¦æƒ…:', fileId);
        window.location.href = `/file_detail/${fileId}`;
    }

    // æŒ‰Enteré”®æœç´¢
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchFiles();
        }
    });

    // æ·»åŠ é¡µé¢åŠ è½½å®Œæˆåçš„æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ç¤¾åŒºé¡µé¢åŠ è½½å®Œæˆï¼Œæ–‡ä»¶è¯¦æƒ…åŠŸèƒ½å·²å°±ç»ª');
    });
    </script>
    
</body>
</html>